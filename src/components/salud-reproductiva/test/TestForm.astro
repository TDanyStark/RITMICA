---
import { criterios } from "@/data/CriteriosEligibilidad";
---

<div class="w-full max-w-4xl mx-auto px-2 md:px-4 mb-2 relative flex items-center gap-2">
  <div class="relative flex-1">
    <input
      type="text"
      id="search-input"
      placeholder="Buscar criterio..."
      class="w-full py-3 px-6 pr-12 rounded-xl md:rounded-full border-2 border-purple-abbott text-purple-abbott placeholder-purple-abbott/50 focus:outline-none focus:bg-white/50 bg-white/90 shadow-sm text-lg transition-all"
    />
    <button
      id="clear-search"
      class="absolute right-4 top-1/2 -translate-y-1/2 text-purple-abbott hover:text-purple-900 transition-colors hidden"
      aria-label="Borrar búsqueda"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        class="h-6 w-6"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M6 18L18 6M6 6l12 12"></path>
      </svg>
    </button>
  </div>
  <button
    id="toggle-all-btn"
    class="bg-white/90 text-purple-abbott p-3 rounded-full shadow-sm border-2 border-purple-abbott hover:bg-purple-abbott hover:text-white transition-all"
    aria-label="Expandir/Colapsar todo"
    title="Expandir/Colapsar todo"
  >
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4" />
    </svg>
  </button>
</div>

<div
  id="form-container"
  class="flex flex-col gap-4 w-full max-w-4xl mx-auto p-2 md:p-4"
>
  <!-- Rendered via JS -->
</div>

<div
  id="results-drawer"
  class="fixed bottom-0 left-0 right-0 bg-white shadow-[0_-4px_20px_rgba(0,0,0,0.15)] z-50 rounded-t-3xl transition-all duration-300 transform translate-y-[calc(100%-5rem)]"
>
  <!-- Handle / Summary Bar -->
  <button
    id="drawer-toggle"
    class="w-full h-20 flex items-center justify-between px-4 md:px-8 bg-white rounded-t-3xl relative z-20 focus:outline-none group"
  >
    <div
      class="flex items-center gap-2 md:gap-4 overflow-x-auto no-scrollbar flex-1 pr-4"
      id="results-summary"
    >
      <!-- Results will be injected here -->
      <span class="text-gray-400 italic"
        >Selecciona criterios para ver resultados...</span
      >
    </div>

    <div class="flex items-center gap-4">
        <div 
            id="reset-test-btn"
            class="p-2 text-purple-abbott hover:bg-purple-100 rounded-full cursor-pointer transition-colors"
            title="Reiniciar Test"
        >
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
        </div>

        <div
        class="flex flex-col items-center justify-center text-purple-abbott opacity-50 group-hover:opacity-100 transition-opacity"
        >
        <svg
            id="drawer-icon"
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6 transition-transform duration-300"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
        >
            <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M5 15l7-7 7 7"></path>
        </svg>
        </div>
    </div>
  </button>

  <!-- Expanded Content -->
  <div
    class="bg-gray-50 p-6 md:p-8 pb-10 max-h-[60vh] overflow-y-auto border-t border-gray-100"
  >
    <div class="max-w-4xl mx-auto">
      <h3 class="text-purple-abbott font-bold text-xl mb-6">
        Referencia de Métodos
      </h3>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="flex items-start gap-3 p-3 rounded-lg bg-white shadow-sm">
          <span class="font-bold text-purple-abbott">AOC</span>
          <span class="text-sm text-gray-600"
            >Anticonceptivos orales combinados</span
          >
        </div>
        <div class="flex items-start gap-3 p-3 rounded-lg bg-white shadow-sm">
          <span class="font-bold text-purple-abbott">IM</span>
          <span class="text-sm text-gray-600">Inyectables mensuales</span>
        </div>
        <div class="flex items-start gap-3 p-3 rounded-lg bg-white shadow-sm">
          <span class="font-bold text-purple-abbott">AVC</span>
          <span class="text-sm text-gray-600">Anillo vaginal combinado</span>
        </div>
        <div class="flex items-start gap-3 p-3 rounded-lg bg-white shadow-sm">
          <span class="font-bold text-purple-abbott">PSP</span>
          <span class="text-sm text-gray-600"
            >Píldoras de solo progestágeno</span
          >
        </div>
        <div class="flex items-start gap-3 p-3 rounded-lg bg-white shadow-sm">
          <span class="font-bold text-purple-abbott">ISP</span>
          <span class="text-sm text-gray-600"
            >Inyectables de solo progestágeno</span
          >
        </div>
        <div class="flex items-start gap-3 p-3 rounded-lg bg-white shadow-sm">
          <span class="font-bold text-purple-abbott">IMP</span>
          <span class="text-sm text-gray-600">Implantes</span>
        </div>
      </div>

      <h3 class="text-purple-abbott font-bold text-xl mt-8 mb-4">Categorías</h3>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div class="flex items-center gap-3">
          <div
            class="w-8 h-8 rounded-full bg-[#009A44] text-white flex items-center justify-center font-bold"
          >
            1
          </div>
          <span class="text-sm">Use el método en cualquier circunstancia.</span>
        </div>
        <div class="flex items-center gap-3">
          <div
            class="w-8 h-8 rounded-full bg-[#8BC53F] text-white flex items-center justify-center font-bold"
          >
            2
          </div>
          <span class="text-sm">En general, use el método.</span>
        </div>
        <div class="flex items-center gap-3">
          <div
            class="w-8 h-8 rounded-full bg-[#FDB913] text-white flex items-center justify-center font-bold"
          >
            3
          </div>
          <span class="text-sm">En general, no se recomienda el método.</span>
        </div>
        <div class="flex items-center gap-3">
          <div
            class="w-8 h-8 rounded-full bg-[#E30613] text-white flex items-center justify-center font-bold"
          >
            4
          </div>
          <span class="text-sm">No use el método.</span>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .no-scrollbar::-webkit-scrollbar {
    display: none;
  }
  .no-scrollbar {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
</style>

<script is:inline define:vars={{ criterios }}>
  const container = document.getElementById("form-container");
  const searchInput = document.getElementById("search-input");
  const clearSearchBtn = document.getElementById("clear-search");
  let formState = {};

  // Helper to determine if a list of nodes should be a radio group
  function isRadioGroup(nodes) {
    if (!nodes || nodes.length <= 1) return false;
    return nodes.every((node) => node.values && !node.children);
  }

  function filterNodes(nodes, term) {
    if (!term) return nodes;

    return nodes
      .map((node) => {
        const labelMatch = node.label
          .toLowerCase()
          .includes(term.toLowerCase());

        if (node.children) {
          const filteredChildren = filterNodes(node.children, term);
          const hasMatchingChild = filteredChildren.length > 0;

          if (labelMatch) {
            // Match on this category: Return it with ALL children (original), expanded
            return { ...node, _forceOpen: true };
          } else if (hasMatchingChild) {
            // Match in descendants: Return with filtered children, expanded
            return { ...node, children: filteredChildren, _forceOpen: true };
          }
        } else {
          // Leaf node
          if (labelMatch) return node;
        }
        return null;
      })
      .filter((n) => n !== null);
  }

  function createButton(label, id, isExpanded) {
    const btn = document.createElement("button");
    btn.className =
      "accordion-trigger menu-btn bg-white/90 text-purple-abbott rounded-xl md:rounded-full py-4 px-8 text-left text-xl md:text-2xl uppercase shadow-md hover:text-white hover:font-bold hover:scale-[1.02] hover:bg-purple-abbott transition-all w-full flex justify-between items-center";
    btn.id = id;

    const spanLabel = document.createElement("span");
    spanLabel.textContent = label;

    const spanIcon = document.createElement("span");
    spanIcon.className = "icon text-2xl transition-transform duration-300";
    spanIcon.textContent = "▼";
    if (isExpanded) spanIcon.style.transform = "rotate(180deg)";

    btn.appendChild(spanLabel);
    btn.appendChild(spanIcon);

    return { btn, icon: spanIcon };
  }

  function createInputRow(node, path, type, groupName) {
    const label = document.createElement("label");
    label.className =
      "text-purple-abbott py-2 px-8 text-left text-xl md:text-2xl uppercase w-full flex items-start gap-4 cursor-pointer group transition-opacity hover:opacity-75";

    const inputContainer = document.createElement("div");
    inputContainer.className = "relative flex items-center mt-1";

    const input = document.createElement("input");
    input.type = type;
    input.className =
      "peer h-6 w-6 min-w-[1.5rem] cursor-pointer appearance-none border-2 border-purple-abbott checked:bg-purple-abbott transition-all bg-transparent";

    if (type === "checkbox") {
      input.classList.add("rounded");
    } else {
      input.classList.add("rounded-full");
    }

    input.name = groupName || path; // Group name for radios, path for checkbox
    input.value = JSON.stringify(node.values || {});
    input.dataset.path = path;

    const indicator = document.createElement("div");
    indicator.className =
      "absolute inset-0 flex items-center justify-center pointer-events-none opacity-0 peer-checked:opacity-100 transition-opacity";

    if (type === "radio") {
      // Inner circle for radio
      const dot = document.createElement("div");
      dot.className = "w-2.5 h-2.5 bg-white rounded-full";
      indicator.appendChild(dot);
    } else {
      // Checkmark for checkbox
      indicator.innerHTML = `<svg class="w-4 h-4 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12" /></svg>`;
    }

    inputContainer.appendChild(input);
    inputContainer.appendChild(indicator);

    const textSpan = document.createElement("span");
    textSpan.className = "flex-1 leading-tight";
    textSpan.textContent = node.label;

    label.appendChild(inputContainer);
    label.appendChild(textSpan);

    // Event Listener
    input.addEventListener("change", (e) => {
      const target = e.target;
      let val = {};
      try {
        val = JSON.parse(target.value);
      } catch (err) {}

      if (type === "radio") {
        formState[groupName] = {
          path: path,
          values: val,
          type: "radio",
        };
      } else {
        if (target.checked) {
          formState[path] = {
            values: val,
            type: "checkbox",
          };
        } else {
          delete formState[path];
        }
      }
      // console.log("Form State:", formState);
      updateDrawer();
    });

    return label;
  }

  function renderNodes(nodes, parentContainer, parentPath = "", level = 0) {
    if (!nodes) return;

    const isGroupRadio = isRadioGroup(nodes);
    const groupName = isGroupRadio ? `group-${parentPath}` : null;

    nodes.forEach((node, index) => {
      const currentPath = parentPath ? `${parentPath}-${index}` : `${index}`;

      // Case 1: Node is a Group (has children)
      if (node.children) {
        const wrapper = document.createElement("div");
        wrapper.className = "w-full flex flex-col gap-4"; // Added gap for spacing

        const { btn, icon } = createButton(
          node.label,
          `btn-${currentPath}`,
          node._forceOpen
        );

        const content = document.createElement("div");
        content.id = `content-${currentPath}`;

        // Apply border and indentation to all levels (Level 0 content = Level 1 items, etc.)
        // "linea mas pegada al contenido" -> reduced pl (pl-3)
        // "agrega un margin" -> ml-4 md:ml-8 to indent the whole block
        content.className =
          "hidden flex-col gap-3 mt-4 pl-3 border-l-2 border-purple-abbott/30 ml-4 md:ml-8";

        if (node._forceOpen) {
          content.classList.remove("hidden");
          content.classList.add("flex");
        }

        btn.onclick = (e) => {
          e.stopPropagation();
          const isHidden = content.classList.contains("hidden");
          if (isHidden) {
            content.classList.remove("hidden");
            content.classList.add("flex");
            icon.style.transform = "rotate(180deg)";
          } else {
            content.classList.add("hidden");
            content.classList.remove("flex");
            icon.style.transform = "rotate(0deg)";
          }
        };

        wrapper.appendChild(btn);
        wrapper.appendChild(content);
        parentContainer.appendChild(wrapper);

        // Recurse
        renderNodes(node.children, content, currentPath, level + 1);
      }
      // Case 2: Node is a Leaf (has values)
      else if (node.values) {
        const type = isGroupRadio ? "radio" : "checkbox";
        const row = createInputRow(node, currentPath, type, groupName);
        parentContainer.appendChild(row);
      }
    });
  }

  searchInput.addEventListener("input", (e) => {
    const term = e.target.value;

    if (term.length > 0) {
      clearSearchBtn.classList.remove("hidden");
    } else {
      clearSearchBtn.classList.add("hidden");
    }

    const filtered = filterNodes(criterios, term);
    container.innerHTML = ""; // Clear
    renderNodes(filtered, container);
  });

  clearSearchBtn.addEventListener("click", () => {
    searchInput.value = "";
    clearSearchBtn.classList.add("hidden");
    container.innerHTML = "";
    renderNodes(criterios, container);
    searchInput.focus();
  });

  // Toggle All Logic
  const toggleAllBtn = document.getElementById("toggle-all-btn");

  if (toggleAllBtn) {
    toggleAllBtn.addEventListener("click", () => {
        const allContents = document.querySelectorAll('[id^="content-"]');
        // Check if ANY content is currently visible (expanded)
        const anyExpanded = Array.from(allContents).some(content => !content.classList.contains("hidden"));
        
        const triggers = document.querySelectorAll(".accordion-trigger");
        triggers.forEach(btn => {
            const contentId = btn.id.replace("btn-", "content-");
            const content = document.getElementById(contentId);
            const icon = btn.querySelector(".icon");
            
            if (content && icon) {
                if (anyExpanded) {
                    // Collapse All
                    content.classList.add("hidden");
                    content.classList.remove("flex");
                    icon.style.transform = "rotate(0deg)";
                } else {
                    // Expand All
                    content.classList.remove("hidden");
                    content.classList.add("flex");
                    icon.style.transform = "rotate(180deg)";
                }
            }
        });
    });
  }

  // Reset Logic
  const resetTestBtn = document.getElementById("reset-test-btn");
  
  if (resetTestBtn) {
    resetTestBtn.addEventListener("click", (e) => {
        e.stopPropagation(); // Prevent drawer toggle
        
        // Clear state
        formState = {};
        
        // Clear search
        searchInput.value = "";
        clearSearchBtn.classList.add("hidden");
        
        // Re-render (clears inputs)
        container.innerHTML = "";
        renderNodes(criterios, container);
        
        // Update drawer
        updateDrawer();
    });
  }

  // Initial Render
  renderNodes(criterios, container);

  // Drawer Logic
  const drawerToggle = document.getElementById("drawer-toggle");
  const resultsDrawer = document.getElementById("results-drawer");
  const drawerIcon = document.getElementById("drawer-icon");
  const resultsSummary = document.getElementById("results-summary");

  if (drawerToggle) {
    drawerToggle.addEventListener("click", () => {
      const isClosed = resultsDrawer.classList.contains(
        "translate-y-[calc(100%-5rem)]"
      );
      if (isClosed) {
        // Open
        resultsDrawer.classList.remove("translate-y-[calc(100%-5rem)]");
        resultsDrawer.classList.add("translate-y-0");
        drawerIcon.style.transform = "rotate(180deg)";
      } else {
        // Close
        resultsDrawer.classList.remove("translate-y-0");
        resultsDrawer.classList.add("translate-y-[calc(100%-5rem)]");
        drawerIcon.style.transform = "rotate(0deg)";
      }
    });
  }

  function getBadgeColor(num) {
    switch (num) {
      case 1:
        return "bg-[#009A44]";
      case 2:
        return "bg-[#8BC53F]";
      case 3:
        return "bg-[#FDB913]";
      case 4:
        return "bg-[#E30613]";
      default:
        return "bg-gray-400";
    }
  }

  function calculateScores() {
    const methods = ["AOC", "IM", "AVC", "PSP", "ISP", "IMP"];
    const result = {};
    const selectedValues = Object.values(formState).map((s) => s.values);

    // If no selection, return null to show placeholder
    if (selectedValues.length === 0) return null;

    methods.forEach((method) => {
      let maxI = 0;
      let maxC = 0;
      let hasN = false;
      let hasValue = false;

      selectedValues.forEach((valObj) => {
        const val = valObj[method];
        if (val === undefined) return;

        hasValue = true;
        if (val === "N") {
          hasN = true;
        } else if (typeof val === "number") {
          if (val > maxI) maxI = val;
          if (val > maxC) maxC = val;
        } else if (typeof val === "object" && val !== null) {
          if (val.I > maxI) maxI = val.I;
          if (val.C > maxC) maxC = val.C;
        }
      });

      if (hasN) {
        result[method] = "N";
      } else if (hasValue) {
        // If we found values, use the max found.
        // If maxI is still 0 (e.g. only 'N' was found but handled above, or empty objects?),
        // actually if hasValue is true and not N, we should have numbers.
        // Unless the value was {I:0, C:0} which shouldn't happen.
        // Default to 1 if for some reason we have a selection but no risk?
        // Actually, if I select a condition that doesn't mention AOC, val is undefined.
        // If I select a condition that has AOC: 1, maxI=1.
        // If I select multiple, we take max.
        // If maxI is 0, it means we only encountered undefineds? No, hasValue checks that.
        result[method] = { I: maxI || 1, C: maxC || 1 };
      } else {
        // No selection touched this method. Default to 1?
        // If the user has selected *something*, usually we assume 1 for everything else unless specified.
        result[method] = { I: 1, C: 1 };
      }
    });

    return result;
  }

  function updateDrawer() {
    const scores = calculateScores();
    resultsSummary.innerHTML = "";

    if (!scores) {
      resultsSummary.innerHTML =
        '<span class="text-gray-400 italic">Selecciona criterios para ver resultados...</span>';
      return;
    }

    Object.entries(scores).forEach(([method, score]) => {
      if (score === "N") return; // Don't show

      const wrapper = document.createElement("div");
      wrapper.className = "flex flex-col items-center min-w-[3rem]";

      const badge = document.createElement("div");
      // Base classes
      badge.className =
        "w-10 h-10 rounded-full text-white font-bold flex items-center justify-center shadow-sm text-lg mb-1 transition-colors";

      let text = "";
      let colorClass = "";

      if (score.I === score.C) {
        text = score.I;
        colorClass = getBadgeColor(score.I);
      } else {
        text = `${score.I}|${score.C}`;
        const maxVal = Math.max(score.I, score.C);
        colorClass = getBadgeColor(maxVal);
        badge.classList.add("text-sm");
      }

      // Add color class
      // We use the exact strings that are present in the HTML to ensure Tailwind picks them up
      if (colorClass === "bg-[#009A44]") badge.classList.add("bg-[#009A44]");
      else if (colorClass === "bg-[#8BC53F]")
        badge.classList.add("bg-[#8BC53F]");
      else if (colorClass === "bg-[#FDB913]")
        badge.classList.add("bg-[#FDB913]");
      else if (colorClass === "bg-[#E30613]")
        badge.classList.add("bg-[#E30613]");
      else badge.classList.add("bg-gray-400");

      badge.textContent = text;

      const label = document.createElement("span");
      label.className = "text-xs font-bold text-purple-abbott";
      label.textContent = method;

      wrapper.appendChild(badge);
      wrapper.appendChild(label);
      resultsSummary.appendChild(wrapper);
    });
  }
</script>
